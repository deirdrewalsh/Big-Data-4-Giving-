var data = [
{
    type: "dataset",
    name: "FEMA",
    image: "./static/img/fema-logo-white.png?raw=true",
    description: "Access the Disaster Declarations dataset from the Federal Emergency Management Agency to see what emergencies have occurred in your area.",
    links: [{
        url: "https://github.com/uscensusbureau/citysdk/blob/master/js/citysdk.fema.js",
        title: "CitySDK FEMA Module"
    }, {
        url: "./examples/femaExample/",
        title: "Demo: Disaster Declaration Summaries"
    }]
},
{
    type: "technology",
    name: "Civic Spark",
    image: "https://cdn.rawgit.com/jmeisel/galleryicons/master/civicspark.png?raw=true",
    description: "The CivicSpark App is for civic tech leaders and entrepreneurs to more easily find free or low-cost spaces in their local communities to meet, teach, and innovate.",
    links: [{
        url: "https://github.com/dssg/innovation-ecosystems",
        title: "Dataset Collection and Exploration"
    }, {
        url: "http://civicspark.co/",
        title: "App: Civic Spark (prototype)"
    }]
},
{
    type: "technology",
    name: "Austin Parks Equity",
    image: "https://cdn.rawgit.com/jmeisel/galleryicons/master/austinparkequity.png?raw=true",
    description: "This is a civic app that aims to help visualize how Austin's park resources are distributed throughout the City of Austin.",
    links: [{
        url: "https://github.com/open-austin/Austin_Parks_Equity",
        title: "Github Repo: Austin Parks Equity"
    }, {
        url: "https://github.com/open-austin/atx-citysdk-js",
        title: "App: Austin Parks Equity (prototype)"
    }]
},
    {
    type: "technology",
    name: "Hyperlocal",
    image: "https://cdn.rawgit.com/jmeisel/galleryicons/master/hyperlocal.png?raw=true",
    description: "HyperLocal helps Food Truck operators without a lottery parking spot find customers by locating tweets from those who are hungry.",
    links: [{
        url: "https://dchackforchange.herokuapp.com/",
        title: "App: Who's Hungry? (prototype)"
    }]
},
    {
    type: "technology",
    name: "Purshable",
    image: "https://cdn.rawgit.com/jmeisel/galleryicons/master/purshable.png?raw=true",
    description: "Purshable is a mobile app that will help reduce waste, increase grocerâ€™s profit, and offer the shopper high quality food at a fraction of the cost.",
    links: [{
        url: "http://www.purshable.com/",
        title: "Purshable website"
    }]
},
    {
    type: "technology",
    name: "Accessible Places Finder",
    image: "https://cdn.rawgit.com/jmeisel/galleryicons/master/accessibility.png?raw=true",
    description: "This app aims to help people with disabilities to easily find a place to live or travel in the state of Minnesota that satisfies the specific accessibility needs of this population group.",
    links: [{
        url: "http://website-mnhomefinder.rhcloud.com/accessibilityscore/",
        title: "App: Accessible Places Finder (prototype)"
    }]
},
{
    type: "dataset",
    name: "US Census Bureau",
    image: "https://cdn.rawgit.com/jmeisel/galleryicons/master/census.png?raw=true",
    description: "The Census Bureau's mission is to serve as the leading source of quality data about the nation's people and economy.",
    links: [{
        url: "",
        title: ""
    }, {
        url: "",
        title: ""
    }]
},
            {
    type: "technology",
    name: "Leaflet",
    image: "https://cdn.rawgit.com/jmeisel/galleryicons/master/leaflet.png?raw=true",
    description: "Leaflet is an Open-Source JavaScript library for web and mobile friendly interactive maps.  It uses the GeoJSON format.",
    links: [{
        url: "http://uscensusbureau.github.io/citysdk/examples/leafletNYC/",
        title: "Demo: Leaflet NYC Boroughs"
    }]
},
{
    type: "dataset",
    name: "Housing and Urban Development",
    image: "https://cdn.rawgit.com/jmeisel/galleryicons/master/hud.png",
    description: "Access data on FHA Loans, HUD Insured Properties, Fair Market Rents and dozens of other datasets related to national housing and property issues.",
    links: [{
        url: "https://github.com/esridc/citysdk-hud",
        title: "CitySDK HUD Module"
    }, {
        url: "http://esridc.github.io/citysdk-hud/",
        title: "Demo: Housing Loans in Pittsburgh"
    }]
},
  {
    type: "dataset",
    name: "US Department of Agriculture",
    image: "https://cdn.rawgit.com/jmeisel/galleryicons/master/usda.png?raw=true",
    description: "Discover fresh food near you with the National Farmer's Market directory module.",
    links: [{
        url: "https://github.com/uscensusbureau/citysdk/blob/master/js/citysdk.farmersMarket.js",
        title: "CitySDK Farmer's Market Module"
    }, {
        url: "http://uscensusbureau.github.io/citysdk/guides/usingMultipleModules.html",
        title: "Demo: Farmer's Markets in California"
    }]
},
      {
    type: "dataset",
    name: "US Department of Energy",
    image: "https://cdn.rawgit.com/jmeisel/galleryicons/master/doe.png?raw=true",
    description: "Access the extensive datasets of the U.S. Energy Information Agency, browse various categories and use their data series in your visualizations.",
    links: [{
        url: "https://github.com/uscensusbureau/citysdk/blob/master/js/citysdk.eia.js",
        title: "CitySDK Energy Information Agency Module"
    }, {
        url: "http://uscensusbureau.github.io/citysdk/examples/eiaBrowser/",
        title: "Demo: Energy Information Agency browser"
    }]
},
      {
    type: "technology",
    name: "ESRI",
    image: "https://cdn.rawgit.com/jmeisel/galleryicons/master/esri.png?raw=true",
    description: "Governments, industry leaders, academics, and nongovernmental organizations (NGOs) use ESRI to connect with analytic knowledge they need to make decisions.",
    links: [{
        url: "http://esridc.github.io/citysdk-arcgis/",
        title: "ESRI ArcGIS Module"
    }, {
        url: "http://esridc.github.io/citysdk-arcgis/chart.html",
        title: "Demo: Chart Showing DC School Enrollment"
    }]
},
          {
    type: "technology",
    name: "Socrata",
    image: "https://cdn.rawgit.com/jmeisel/galleryicons/master/socrata.png?raw=true",
    description: "The Socrata platform is commonly used by municipal, state, and federal agencies use to distribute their data.",
    links: [{
        url: "https://github.com/uscensusbureau/citysdk/blob/master/js/citysdk.socrata.js",
        title: "CitySDK Socrata Module"
    }, {
        url: "http://uscensusbureau.github.io/citysdk/examples/socrataExample/",
        title: "Demo: Chicago Payroll Query"
    }, {
        url: "{http://uscensusbureau.github.io/citysdk/apps/chicagoCAD/",
        title: "Demo: Chicago Crime and Demographics"
    }]
},
    {
    type: "technology",
    name: "Google Maps",
    image: "https://cdn.rawgit.com/jmeisel/galleryicons/master/googlemaps.png?raw=true",
    description: "There are several CitySDK examples that utilize Google Maps to create interactive web apps.",
    links: [{
        url: "http://uscensusbureau.github.io/citysdk/guides/usingMultipleModules.html",
        title: "Demo: Farmer's Markets in California"
    }, {
        url: "http://esridc.github.io/citysdk-hud/",
        title: "Demo: Housing Loans in Pittsburgh"
    },
    ]
},
   {
    type: "technology",
    name: "Bing Maps",
    image: "https://cdn.rawgit.com/jmeisel/galleryicons/master/bing.png?raw=true",
    description: "CitySDK apps can be built with Microsoft Bing's mapping technology.",
    links: [{
        url: "http://uscensusbureau.github.io/citysdk/",
        title: "Demo: Using Bing Maps with the CitySDK"
         },
    ]
}];


(function(){

  if (!document.cookie.match("visited=true")) {
    introJs().setOption('showBullets', false).start();
    document.cookie = "visited=true";
  }

  // Create map
  var simpleMap =
    L.map('map-austin', {
      center: [30.2665301, -97.7407723],
      zoom: 14
    });

  L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
  	maxZoom: 18,
  	attribution: '<a href="http://openstreetmap.org">OpenStreetMap</a> | <a href="http://mapbox.com">Mapbox</a>',
  	id: 'drmaples.ipbindf8',
  }).addTo(simpleMap);

  var geojson, legend;

  function loadDataset(dataset) {
    var bounds = simpleMap.getBounds();
    var convertedCoordsNortheast = Terraformer.Tools.positionToMercator([bounds._northEast.lng, bounds._northEast.lat]);
    var convertedCoordsSouthwest = Terraformer.Tools.positionToMercator([bounds._southWest.lng, bounds._southWest.lat]);

    console.log(convertedCoordsNortheast, convertedCoordsSouthwest);

    var xmin = -10885292.097177874;
    var ymin = 3534964.13784741;
    var xmax = -10875622.813099798;
    var ymax = 3540754.2427400113;

    function getColor(d) {
      return d > 99 ? '#FFEDA0' :
             d > 80 ? '#FED976' :
             d > 65 ? '#FEB24C' :
             d > 50 ? '#FD8D3C' :
             d > 35 ? '#FC4E2A' :
             d > 25 ? '#E31A1C' :
             d > 13 ? '#BD0026' :
                      '#800026';
    }

    var url = 'http://23.22.19.64:5000/query?xmin=' + xmin.toString() + '&xmax=' + xmax.toString() + '&ymin=' + ymin.toString() + '&ymax=' + ymax.toString() + '&dataset=' + dataset;
    if (geojson != undefined) {
      simpleMap.removeLayer(geojson);
      simpleMap.removeControl(legend);
    }
    $.getJSON(url, function(data) {
      console.log(data);
      if (!data.hasOwnProperty('features')) {
        return;
      }

      function highlightFeature(feature) {
        var layer = feature.target;

        layer.setStyle({
          weight: 5,
          color: '#666',
          dashArray: '',
          fillOpacity: 0.7
        });

        if (!L.Browser.ie && !L.Browser.opera) {
          layer.bringToFront();
        }
      }

      function zoomToFeature(e) {
        simpleMap.fitBounds(e.target.getBounds());
        $('#charities').addClass('charities-panel--active');
      }

      function resetHighlight(feature) {
        geojson.resetStyle(feature.target);
      }

      function onEachFeature(feature, layer) {
        layer.on({
          mouseover: highlightFeature,
          mouseout: resetHighlight,
          click: zoomToFeature
        });
      }

      geojson = L.geoJson(data, {onEachFeature: onEachFeature, style: function(feature) {
        var key = (dataset == 'Low Poverty') ? 'POV_IDX' : 'SCHL_IDX';
        return {
          fillColor: getColor(feature.properties[key]),
          weight: 2,
          opacity: 1,
          color: 'white',
          dashArray: '3',
          fillOpacity: 0.7
        };
      }});

      geojson.addTo(simpleMap);

      legend = L.control({position: 'topleft'});
      legend.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'info legend');
        var grades = [99, 80, 65, 50, 35, 25, 13, 0];
        var labels = ['Least Need', '', '', '', '', '', '', 'Greatest Need'];

        // loop through our density intervals and generate a label with a colored square for each interval
        for (var i = 0; i < grades.length; i++) {
          div.innerHTML +=
            '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
            labels[i] + '<br>'
        };

        return div;
      };
      legend.addTo(simpleMap);
    });
  }
  document.querySelector("#poverty").addEventListener("click", loadDataset.bind(this, 'Low Poverty'));
  document.querySelector("#education").addEventListener("click", loadDataset.bind(this, 'School Proficiency'));

  // external js: isotope.pkgd.js

  var $grid = $('.grid').isotope({
    itemSelector: '.grid-item',
    stagger: 30,
    layoutMode: 'vertical'
  });

  $('.filter-button-group').on( 'click', '.button', function() {
    var filterValue = $(this).attr('data-filter');
    $grid.isotope({ filter: filterValue });
  });

  // change is-checked class on buttons
  $('.button-group').each( function( i, buttonGroup ) {
    var $buttonGroup = $( buttonGroup );
    $buttonGroup.on( 'click', 'button', function() {
      $buttonGroup.find('.is-checked').removeClass('is-checked');
      $( this ).addClass('is-checked');
    });
  });



})();
